<!--
@license
Copyright 2016 The Advanced REST client authors <arc@mulesoft.com>
Licensed under the Apache License, Version 2.0 (the "License"); you may not
use this file except in compliance with the License. You may obtain a copy of
the License at
http://www.apache.org/licenses/LICENSE-2.0
Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
License for the specific language governing permissions and limitations under
the License.
-->
<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../paper-icon-button/paper-icon-button.html">
<link rel="import" href="../paper-tooltip/paper-tooltip.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../arc-icons/arc-icons.html">
<link rel="import" href="../date-time/date-time.html">
<link rel="import" href="../paper-toast/paper-toast.html">
<link rel="import" href="../paper-dialog/paper-dialog.html">
<link rel="import" href="../paper-button/paper-button.html">

<!--
`<websocket-data-view>` A web socket communication log viewer for web socket request panel

### Example
```
<websocket-data-view></websocket-data-view>
```

### Styling
`<websocket-data-view>` provides the following custom properties and mixins for styling:

Custom property | Description | Default
----------------|-------------|----------
`--websocket-data-view` | Mixin applied to the element | `{}`

@group UI Elements
@element websocket-data-view
@demo demo/index.html
-->
<dom-module id="websocket-data-view">
  <template>
    <style>
    :host {
      display: block;
      @apply --websocket-data-view;
    }

    .table-values {
      @apply --arc-font-body1;
      color: var(--websocket-data-view-table-color, rgba(0, 0, 0, 0.87));
      font-size: var(--websocket-data-view-table-font-size, 13px);
      padding: 16px 24px !important;
      -webkit-user-select: text;
      cursor: text;
    }

    .table-values,
    .table-columns {
      @apply --layout-horizontal;
      @apply --layout-center;
      border-bottom: 1px var(--websocket-data-view-divider-color, rgba(0, 0, 0, 0.12)) solid;
      padding: 0 24px;
    }

    .table-columns:last-child {
      border-bottom: 1px var(--websocket-data-view-last-divider-color, rgba(0, 0, 0, 0)) solid;
    }

    .direction-column,
    .time-column,
    .message-column {
      padding-right: 24px;
    }

    .message-column {
      @apply --layout-flex;
      @apply --layout-horizontal;
      padding-right: 0;
    }

    .time-column,
    .message-column {
      padding-left: 24px;
    }

    .direction-column {
      min-width: 56px;
      padding: 0;
    }

    .time-column {
      min-width: 70px;
    }

    .message-column .message {
      white-space: pre-wrap;
      word-break: normal;
      @apply --layout-flex;
      @apply --websocket-data-view-message;
    }

    #saveDialog {
      min-width: 320px;
    }

    .donnload-section {
      @apply --layout-vertical;
      @apply --layout-center;
    }

    .download-file-icon {
      width: var(--websocket-data-view-download-icon-size, 64px);
      height: var(--websocket-data-view-download-icon-size, 64px);
      color: var(--websocket-data-view-download-icon, --accent-color);
    }

    .dialog-message {
      @apply --websocket-data-view-dialog-message;
    }
    </style>
    <div class="table-columns">
      <div class="direction-column">
        <span>Direction</span>
        <paper-tooltip>Either 'in' for incoming or 'out' for outgoing messages</paper-tooltip>
      </div>
      <div class="time-column">
        <span>Time</span>
        <paper-tooltip>Event time</paper-tooltip>
      </div>
      <div class="message-column">
        <span>Message</span>
        <paper-tooltip>Message sent to / received from the server</paper-tooltip>
      </div>
      <template is="dom-if" if="[[hasMessages]]">
        <span>
          <paper-icon-button data-action="export-all" icon="arc:file-download" on-tap="_exportMessages"></paper-icon-button>
          <paper-tooltip>Export all messages to file</paper-tooltip>
        </span>
        <span>
          <paper-icon-button data-action="clear-all" icon="arc:clear" on-tap="_clearMessages"></paper-icon-button>
          <paper-tooltip>Clear messages log</paper-tooltip>
        </span>
      </template>
    </div>
    <template is="dom-repeat" items="[[messages]]" sort="_sortMessages" id="logList">
      <div class="table-values">
        <div class="direction-column">[[item.direction]]</div>
        <div class="time-column">
          <date-time date="[[item.time]]" hour="numeric" minute="numeric" second="numeric"></date-time>
        </div>
        <div class="message-column">
          <template is="dom-if" if="[[!item.isBinary]]">
            <span class="message">[[item.message]]</span>
          </template>
          <template is="dom-if" if="[[item.isBinary]]">
            <span class="message">[Binary data]</span>
            <span>
              <paper-icon-button data-action="export-binary" icon="arc:file-download" on-tap="_downloadBinnary"></paper-icon-button>
              <paper-tooltip>Download binnary data</paper-tooltip>
            </span>
          </template>
        </div>
      </div>
    </template>

    <paper-dialog id="saveDialog" on-iron-overlay-closed="_downloadDialogClose">
      <h2>Save to file</h2>
      <div>
        <p class="dialog-message">Your file is ready to download. Click on the icon below to save it to your local drive.</p>
        <div class="donnload-section">
          <a href$="[[downloadFileUrl]]" download$="[[downloadFileName]]" on-tap="_downloadIconTap" target="_blank">
            <paper-icon-button data-action="download-file" icon="arc:file-download" class="download-file-icon" title="Download file"></paper-icon-button>
          </a>
        </div>
      </div>
      <div class="buttons">
        <paper-button dialog-dismiss autofocus>Close</paper-button>
      </div>
    </paper-dialog>

    <paper-toast id="safariDownload" text="Safari doesn't support file download. Please, use other browser."></paper-toast>
    <paper-toast id="noMessages" text="Nothing to export"></paper-toast>
  </template>
  <script>
  Polymer({
    is: 'websocket-data-view',
    /**
     * Fired when the user clears the messages in the UI.
     * The event does not bubble.
     *
     * @event message-cleared
     */
    /**
     * Fired when data export was requested.
     * The event is cancelable. If the event wasn't canceled then the element
     * will use web download as a fallback method.
     *
     * @event export-data
     * @param {Object|Blob} data The data to export.
     * @param {String} type `data` content type
     */
    properties: {
      // List of communication messages with the socket
      messages: {
        type: Array,
        observer: '_messagesChanged'
      },
      // Computed value, true if messages are set.
      hasMessages: {
        type: Boolean,
        readOnly: true
      },
      /**
       * When saving a file this will be the download URL created by the
       * `URL.createObjectURL` function.
       */
      downloadFileUrl: {
        type: String,
        readOnly: true
      },
      /**
       * Autogenerated file name for the download file.
       */
      downloadFileName: {
        type: String,
        readOnly: true
      },
      // Computed value. True is current browser is Safari - the new IE.
      isSafari: {
        type: Boolean,
        value: function() {
          return /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
        },
        readOnly: true
      }
    },
    // Observer for the `messages` property
    _messagesChanged: function(value) {
      if (value && value.length) {
        this._setHasMessages(true);
      } else {
        this._setHasMessages(false);
      }
    },

    /**
     * Sorts messages in a log so the newest messages are always on top.
     */
    _sortMessages: function(a, b) {
      if (a.time > b.time) {
        return -1;
      }
      if (a.time < b.time) {
        return 1;
      }
      return 0;
    },
    // Returns a list of messages that can be exported.
    _getExportData: function() {
      var data = this.messages;
      if (!data || !data.length) {
        return;
      }
      return data.filter(item => !item.isBinary);
    },
    /**
     * Fires the `export-data` event. If the event is not canceled
     * then it will use default web implementation for file saving.
     */
    _exportMessages: function() {
      var data = this._getExportData();
      if (!data) {
        this.$.noMessages.opened = true;
        return;
      }
      this._exportData(data, 'application/json');
    },
    /**
     * Handler for the "download binary data" button click.
     * Exports the binary data.
     */
    _downloadBinnary: function(e) {
      var item = this.$.logList.modelForElement(e.target).get('item');
      var data = item.message;
      this._exportData(data, data.type || 'application/octet-stream');
    },
    /**
     * Fires `export-data` event or calls `_saveToFile` if event is not handled
     * @param {Object|Blob} data The data to export.
     * @param {String} type `data` content type
     */
    _exportData: function(data, type) {
      var e = this.fire('export-data', {
        data: data,
        type: type
      }, {
        cancelable: true
      });

      if (e.defaultPrevented) {
        return;
      }

      if (this.isSafari) {
        this.$.safariDownload.opened = true;
      } else {
        this._saveToFile(data, type);
      }
    },

    /**
     * Creates a file object form messages objects and opens the dialog
     * with the link to the file.
     */
    _saveToFile: function(data, type) {
      var ext = '';
      if (!(data instanceof Blob)) {
        data = new Blob([JSON.stringify(data, null, 2)], {
          type: type
        });
        ext = '.json';
      } else {
        if (type === 'application/json') {
          ext = '.json';
        } else if (type === 'text/plain') {
          ext = '.txt';
        }
      }
      var fileName = 'socket-messages-' + new Date().toISOString() + ext;
      this._setDownloadFileUrl(URL.createObjectURL(data));
      this._setDownloadFileName(fileName);
      this.$.saveDialog.opened = true;
    },
    // Handler for download link click to prevent default and close the dialog.
    _downloadIconTap: function() {
      this.async(function() {
        this.$.saveDialog.opened = false;
      }, 250);
    },
    // Handler for file download dialog close.
    _downloadDialogClose: function() {
      URL.revokeObjectURL(this.downloadFileUrl);
      this._setDownloadFileUrl(undefined);
      this._setDownloadFileName(undefined);
    },
    // Clears the list of the messages and sends `message-cleared` event.
    _clearMessages: function() {
      this.messages = undefined;
      this.fire('message-cleared', {}, {
        bubbles: false
      });
    }
  });
  </script>
</dom-module>
